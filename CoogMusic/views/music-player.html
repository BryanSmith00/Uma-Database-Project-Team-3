<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Music Player</title>
  <link rel="icon" type="image/x-icon" href="../public/images/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.min.css" />

  <link rel="stylesheet" href="../public/stylesheets/index.css" />
  <link rel="stylesheet" href="../public/stylesheets/music-player.css" />
</head>

<body>

  <nav class="navbar navbar-expand-md">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img class="logo" src="../public/images/coogMusic.png" alt="Coog Music logo">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link active" aria-current="page" href="/">Home</a>
          <a class="nav-link" href="#">Sign up</a>
          <a class="nav-link" href="/login">Sign in</a>
          <a class="nav-link" href="/music">Music</a>
        </div>
      </div>
    </div>
  </nav>

  <header class="player-header">
    <div class="player-overlay"></div>

    <video playsinline="playsinline" autoplay="autoplay" muted="muted" loop="loop">
      <source src="../public/videos/player-header.mp4" type="video/mp4">
    </video>

  </header>


  <div class="music-container" id="music-container">
    <div class="music-info">
      <h4 id="title"></h4>
      <div class="time">
        <div id="currTime">0</div>
        <div id="durTime">0</div>
      </div>
      
      <div class="progress-container" id="progress-container">
        <div class="progress" id="progress"></div>
      </div>
    </div>

    <audio src="https://www.bensound.com/bensound-music/bensound-epic.mp3" id="audio"></audio>

    <div class="navigation">
      <div class="img-container">
        <img class="cover" src="/CoogMusic/public/images/song-cover.png" alt="music-cover" id="cover" />
      </div>
      <div>
        <button id="prev" class="action-btn">
          <i class="fas fa-backward"></i>
        </button>
        <button id="play" class="action-btn action-btn-big">
          <i class="fas fa-play"></i>
        </button>
        <button id="next" class="action-btn">
          <i class="fas fa-forward"></i>
        </button>
      </div>
    </div>
    
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script>
      const musicContainer = document.getElementById("music-container");
      const playBtn = document.getElementById("play");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

    const audio = document.getElementById("audio");
    const progress = document.getElementById("progress");
    const progressContainer = document.getElementById("progress-container");
    const title = document.getElementById("title");
    const cover = document.getElementById("cover");
    const currTime = document.querySelector("#currTime");
    const durTime = document.querySelector("#durTime");

    // Song titles, hard coded for now, populate from our db later
    const songs = ["epic", "slowmotion", "ukulele"];

    // Keep track of song, start at the first
    let songIndex = 0;

    // Initially load song details into DOM, cover is hard coded for now
    loadSong(songs[songIndex]);
    // https://www.bensound.com/bensound-music/bensound-epic.mp3
    // Update song details
    function loadSong(song) {
      title.innerText = song;
      audio.src = `https://www.bensound.com/bensound-music/bensound-${song}.mp3`;
      cover.src = `../public/images/song-cover.png`;
    }

    // Play song
    function playSong() {
      musicContainer.classList.add("play");
      playBtn.querySelector("i.fas").classList.remove("fa-play");
      playBtn.querySelector("i.fas").classList.add("fa-pause");

      audio.play();
    }

    // Pause song
    function pauseSong() {
      musicContainer.classList.remove("play");
      playBtn.querySelector("i.fas").classList.add("fa-play");
      playBtn.querySelector("i.fas").classList.remove("fa-pause");

      audio.pause();
    }

    // Previous song
    function prevSong() {
      songIndex--;

      if (songIndex < 0) {
        songIndex = songs.length - 1;
      }

      loadSong(songs[songIndex]);

      playSong();
    }

    // Next song
    function nextSong() {
      songIndex++;

      if (songIndex > songs.length - 1) {
        songIndex = 0;
      }

      loadSong(songs[songIndex]);

      playSong();
    }

    // Update progress bar
    function updateProgress(e) {
      const { duration, currentTime } = e.srcElement;
      const progressPercent = (currentTime / duration) * 100;
      progress.style.width = `${progressPercent}%`;
    }

    // Set progress bar
    function setProgress(e) {
      const width = this.clientWidth;
      const clickX = e.offsetX;
      const duration = audio.duration;

      audio.currentTime = (clickX / width) * duration;
    }

    //get duration & currentTime for Time of song
    function DurTime(e) {
      const { duration, currentTime } = e.srcElement;
      var sec;
      var sec_d;

      // define minutes currentTime
      let min = currentTime == null ? 0 : Math.floor(currentTime / 60);
      min = min < 10 ? "0" + min : min;

      // define seconds currentTime
      function get_sec(x) {
        if (Math.floor(x) >= 60) {
          for (var i = 1; i <= 60; i++) {
            if (Math.floor(x) >= 60 * i && Math.floor(x) < 60 * (i + 1)) {
              sec = Math.floor(x) - 60 * i;
              sec = sec < 10 ? "0" + sec : sec;
            }
          }
        } else {
          sec = Math.floor(x);
          sec = sec < 10 ? "0" + sec : sec;
        }
      }

      get_sec(currentTime, sec);

      // change currentTime DOM
      currTime.innerHTML = min + ":" + sec;

      // define minutes duration
      let min_d = isNaN(duration) === true ? "0" : Math.floor(duration / 60);
      min_d = min_d < 10 ? "0" + min_d : min_d;

      function get_sec_d(x) {
        if (Math.floor(x) >= 60) {
          for (var i = 1; i <= 60; i++) {
            if (Math.floor(x) >= 60 * i && Math.floor(x) < 60 * (i + 1)) {
              sec_d = Math.floor(x) - 60 * i;
              sec_d = sec_d < 10 ? "0" + sec_d : sec_d;
            }
          }
        } else {
          sec_d = isNaN(duration) === true ? "0" : Math.floor(x);
          sec_d = sec_d < 10 ? "0" + sec_d : sec_d;
        }
      }

      // define seconds duration

      get_sec_d(duration);

      // change duration DOM
      durTime.innerHTML = min_d + ":" + sec_d;
    }

    // Event listeners
    playBtn.addEventListener("click", () => {
      const isPlaying = musicContainer.classList.contains("play");

      if (isPlaying) {
        pauseSong();
      } else {
        playSong();
      }
    });

    // Change song
    prevBtn.addEventListener("click", prevSong);
    nextBtn.addEventListener("click", nextSong);

    // Time/song update
    audio.addEventListener("timeupdate", updateProgress);

    // Click on progress bar
    progressContainer.addEventListener("click", setProgress);

    // Song ends
    audio.addEventListener("ended", nextSong);

    // Time of song
    audio.addEventListener("timeupdate", DurTime);
  </script>
</body>

</html>